<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lær Koranen - Lær Arabisk og Koran</title>
    <link rel="stylesheet" href="new_styles.css?v=2.0">
    <style>
        .verse {
            margin-bottom: 20px;
        }

        .arabic {
            font-size: 24px;
            direction: rtl;
            margin-bottom: 10px;
        }
.arabic-text {
    direction: rtl;
}

        .transliteration {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
	    font-family: serif;
        }

        .translation {
            font-size: 14px;
            color: #555;
        }

        #surah-checkboxes {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
        }

        #surah-checkboxes label {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Lær Koranen</h1>
    </header>
    <nav>
        <a href="index.html">Hjem</a>
        <a href="letters.html">Lær Bokstaver</a>
        <a href="words.html">Lær Ord</a>
        <a href="challenge.html">Ta en Utfordring</a>
        <a href="quran.html">Koranen</a>
        <a href="feedback.html">Gi Tilbakemelding</a>
    </nav>
    <main>
        <h2>Velg en surah og trykk på play</h2>

        <div id="player">
            <button id="open-modal-btn">Velg Suraer</button>

            <div id="sura-selection-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h3>Velg suraher</h3>
                    <input type="text" id="sura-search-input" onkeyup="filterSurahs()" placeholder="Søk etter surah..." style="width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box;">
                    <div id="surah-checkboxes">
                        <!-- Checkboxes will be generated here -->
                    </div>
                    <button id="save-selection-btn">Lagre Valg</button>
                </div>
            </div>

            <br>

            <label for="playbackRate">Velg hastighet på avspilling: </label>
            <select id="playbackRate">
                <option value="0.5">Veldig sakte 0.5x</option>
                <option value="0.75">Sakte 0.75x</option>
                <option value="1" selected>Normal</option>
                <option value="1.25">Rask 1.25x</option>
                <option value="1.5">Veldig rask 1.5x</option>
            </select>

            <br>

            <label for="repeat">Repetisjon: </label>
            <select id="repeat">
                <option value="none">Ingen repetisjon</option>
                <option value="one" selected>Repeter surah</option>
                <option value="all">Repeter alle surah</option>
            </select>

            <br>

            <button onclick="playSelectedSurahs()">Spill av valgte</button>

            <audio id="audioPlayer" controls></audio>

            <div id="transliterationContainer"></div>
        </div>
    </main>
    <footer>
    <p>&copy; 2024 <a href="https://arabisk.prosjekt.pro">Lær Arabisk og Koran</a> | Drevet av Prosjekt.pro</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script>
const audioPlayer = document.getElementById("audioPlayer");
const playbackRateSelect = document.getElementById("playbackRate");
const repeatSelect = document.getElementById("repeat");
const transliterationContainer = document.getElementById("transliterationContainer");
const surahCheckboxesContainer = document.getElementById("surah-checkboxes");
const modal = document.getElementById("sura-selection-modal");
const openModalBtn = document.getElementById("open-modal-btn");
const closeModalBtn = document.querySelector(".close-button");
const saveSelectionBtn = document.getElementById("save-selection-btn");

openModalBtn.onclick = () => modal.style.display = "block";
closeModalBtn.onclick = () => modal.style.display = "none";
saveSelectionBtn.onclick = () => modal.style.display = "none";
window.onclick = (event) => {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

let surahs = {};
let surahDetails = {};
let fuse;

async function fetchQuranData() {
    const cacheKey = 'quranData';
    const cachedData = localStorage.getItem(cacheKey);

    if (cachedData) {
        const data = JSON.parse(cachedData);
        surahs = data.surahs;
        surahDetails = data.surahDetails;

        const surahList = Object.keys(surahs).map(key => ({
            number: key,
            name: surahs[key].name
        }));
        const fuseOptions = { keys: ['name', 'number'], includeScore: true, threshold: 0.4 };
        fuse = new Fuse(surahList, fuseOptions);

        populateCheckboxes();
        displaySurah(1);
        return;
    }

    try {
        const [arabicRes, transliterationRes, translationRes] = await Promise.all([
            fetch('https://api.alquran.cloud/v1/quran/quran-uthmani'),
            fetch('https://api.alquran.cloud/v1/quran/en.transliteration'),
            fetch('https://api.alquran.cloud/v1/quran/no.berg')
        ]);

        const arabicData = await arabicRes.json();
        const transliterationData = await transliterationRes.json();
        const translationData = await translationRes.json();

        // Process the data
        const tempSurahs = {};
        const tempSurahDetails = {};

        arabicData.data.surahs.forEach(surah => {
            tempSurahs[surah.number] = { name: surah.englishName };
            tempSurahDetails[surah.number] = {
                name: surah.englishName,
                arabic: surah.name,
                verses: surah.ayahs.map((ayah, index) => ({
                    arabic: ayah.text,
                    transliteration: '',
                    translation: ''
                }))
            };
        });

        transliterationData.data.surahs.forEach(surah => {
            surah.ayahs.forEach((ayah, index) => {
                tempSurahDetails[surah.number].verses[index].transliteration = ayah.text;
            });
        });

        translationData.data.surahs.forEach(surah => {
            surah.ayahs.forEach((ayah, index) => {
                tempSurahDetails[surah.number].verses[index].translation = ayah.text;
            });
        });

        surahs = tempSurahs;
        surahDetails = tempSurahDetails;

        // Cache the data
        const dataToCache = { surahs, surahDetails };
        localStorage.setItem(cacheKey, JSON.stringify(dataToCache));

        const surahList = Object.keys(surahs).map(key => ({
            number: key,
            name: surahs[key].name
        }));
        const fuseOptions = { keys: ['name', 'number'], includeScore: true, threshold: 0.4 };
        fuse = new Fuse(surahList, fuseOptions);

        populateCheckboxes();
        displaySurah(1); // Display the first surah by default

    } catch (error) {
        console.error("Error fetching Quran data:", error);
        transliterationContainer.innerHTML = "Kunne ikke laste Koranen data. Vennligst prøv igjen senere.";
    }
}


// Populate checkboxes
function populateCheckboxes() {
    for (const surahNumber in surahs) {
        const surah = surahs[surahNumber];
        const entryDiv = document.createElement('div');
        entryDiv.className = 'surah-entry';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `surah-${surahNumber}`;
        checkbox.value = surahNumber;

        const label = document.createElement('label');
        label.htmlFor = `surah-${surahNumber}`;
        label.appendChild(document.createTextNode(`${surahNumber} - ${surah.name}`));

        entryDiv.appendChild(checkbox);
        entryDiv.appendChild(label);
        surahCheckboxesContainer.appendChild(entryDiv);
    }
}

function filterSurahs() {
    const input = document.getElementById('sura-search-input');
    const filter = input.value;
    const surahEntries = document.querySelectorAll('.surah-entry');

    if (!filter.trim()) {
        surahEntries.forEach(entry => {
            entry.style.display = "";
        });
        return;
    }

    const results = fuse.search(filter);
    const visibleIds = results.map(result => `surah-${result.item.number}`);

    surahEntries.forEach(entry => {
        if (visibleIds.includes(entry.querySelector('input').id)) {
            entry.style.display = "";
        } else {
            entry.style.display = "none";
        }
    });
}

let currentlyPlaying = [];
let currentIndex = 0;

function playSelectedSurahs() {
    const selectedCheckboxes = document.querySelectorAll('#surah-checkboxes input[type="checkbox"]:checked');
    currentlyPlaying = Array.from(selectedCheckboxes).map(cb => cb.value);
    currentIndex = 0;

    if (currentlyPlaying.length > 0) {
        playNextSurah();
    } else {
        alert("Vennligst velg minst én surah.");
    }
}

function playNextSurah() {
    if (currentIndex >= currentlyPlaying.length) {
        if (repeatSelect.value === 'all') {
            currentIndex = 0;
        } else {
            return; // Stop playback
        }
    }

    const surahNumber = currentlyPlaying[currentIndex];
    const paddedSurahNumber = surahNumber.toString().padStart(3, '0');
    audioPlayer.src = `./${paddedSurahNumber}.mp3`;
    audioPlayer.playbackRate = parseFloat(playbackRateSelect.value);
    audioPlayer.loop = (repeatSelect.value === 'one');

    displaySurah(surahNumber);

    audioPlayer.onended = () => {
        if (!audioPlayer.loop) {
            currentIndex++;
            playNextSurah();
        }
    };

    audioPlayer.play();
}

function displaySurah(surahNumber) {
    const surah = surahDetails[surahNumber];
    if (!surah) {
        transliterationContainer.innerHTML = "Surah information not available.";
        return;
    }

    let html = `<h2>${surah.name} (${surahNumber})</h2>`;
    html += `<div class="arabic">${surah.arabic}</div>`;

    surah.verses.forEach((verse, index) => {
        html += `<div class="verse">`;
        html += `<div class="arabic">${verse.arabic}</div>`;
        html += `<div class="transliteration">${verse.transliteration}</div>`;
        html += `<div class="translation">${verse.translation}</div>`;
        html += `</div>`;
    });

    transliterationContainer.innerHTML = html;

    // Scroll the text into view
    setTimeout(() => {
        transliterationContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}

// Fetch Quran data when the page loads
fetchQuranData();
</script>
</body>
</html>
